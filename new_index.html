<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Finder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }
        nav {
            background-color: #444;
            padding: 10px;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 16px;
        }
        nav a:hover {
            text-decoration: underline;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .filters select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
        }
        .restaurant-list, .menu-item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .restaurant-card, .menu-item-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .restaurant-card h3, .menu-item-card h4 {
            margin: 0 0 10px;
            color: #333;
        }
        .menu-item-card p {
            margin: 5px 0;
            color: #666;
        }
        .customization {
            margin-top: 10px;
        }
        .customization select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
        }
        .customization button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .customization button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <header>
        <h1>Restaurant Finder</h1>
    </header>
    <nav>
        <a href="/index.html">Map View</a>
        <a href="/restaurants.html">Restaurant List</a>
        <a href="/archive.html">Archive</a>
        <a href="/trip-planner.html">Trip Planner</a>
        <a href="/game.html">Game</a>
        <a href="/social-feed.html">Social Feed</a>
        <a href="/preferences.html">Preferences</a>
        <a href="/add-restaurant.html">Add Restaurant</a>
    </nav>
    <div class="container">
        <h2>Restaurants & Menus</h2>
        <div class="filters">
            <select id="cuisine-filter">
                <option value="">All Cuisines</option>
                <!-- Populated dynamically -->
            </select>
            <select id="diet-filter">
                <option value="">All Diets</option>
                <!-- Populated dynamically -->
            </select>
        </div>
        <div class="restaurant-list" id="restaurant-list">
            <!-- Restaurant cards will be populated here -->
        </div>
    </div>
    <script>
        async function fetchRestaurants() {
            try {
                const response = await fetch('http://localhost:3000/api/all-restaurant-menus');
                const restaurants = await response.json();
                displayRestaurants(restaurants);
            } catch (err) {
                console.error('Error fetching restaurants:', err);
            }
        }

        async function fetchProteinOptions() {
            try {
                const response = await fetch('http://localhost:3000/api/protein-options-with-portions');
                const proteinOptions = await response.json();
                return proteinOptions;
            } catch (err) {
                console.error('Error fetching protein options:', err);
                return [];
            }
        }

        async function fetchDiets() {
            // Simulating fetching diets from global taxonomy
            return [
                { diet_id: 1, diet_name: 'Vegetarian' },
                { diet_id: 2, diet_name: 'Vegan' }
            ];
        }

        async function populateFilters() {
            const dietFilter = document.getElementById('diet-filter');
            const diets = await fetchDiets();
            diets.forEach(diet => {
                const option = document.createElement('option');
                option.value = diet.diet_name.toLowerCase();
                option.textContent = diet.diet_name;
                dietFilter.appendChild(option);
            });
        }

        function displayRestaurants(restaurants) {
            const restaurantList = document.getElementById('restaurant-list');
            restaurantList.innerHTML = '';
            restaurants.forEach(restaurant => {
                const restaurantCard = document.createElement('div');
                restaurantCard.className = 'restaurant-card';
                restaurantCard.innerHTML = `
                    <h3>${restaurant.restaurant_name}</h3>
                    <div class="menu-item-list">
                        ${restaurant.menus.map(menu => `
                            <div>
                                <h4>${menu.menu_name}</h4>
                                ${menu.items.map(item => `
                                    <div class="menu-item-card">
                                        <h4>${item.item_name}</h4>
                                        <p>${item.description}</p>
                                        <p>Price: $${item.base_price.toFixed(2)}</p>
                                        <div class="customization">
                                            <select id="protein-${item.menu_item_id}">
                                                <option value="">Select Protein</option>
                                            </select>
                                            <button onclick="applyCustomization('${item.menu_item_id}', '${item.item_name}')">Apply</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
                restaurantList.appendChild(restaurantCard);
                // Populate protein options for each menu item
                populateProteinOptions(restaurant.menus);
            });
        }

        async function populateProteinOptions(menus) {
            const proteinOptions = await fetchProteinOptions();
            menus.forEach(menu => {
                menu.items.forEach(item => {
                    const select = document.getElementById(`protein-${item.menu_item_id}`);
                    proteinOptions.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value_id;
                        opt.textContent = `${option.value_name} (${option.default_portion})`;
                        select.appendChild(opt);
                    });
                });
            });
        }

        function applyCustomization(menuItemId, itemName) {
            const select = document.getElementById(`protein-${menuItemId}`);
            const selectedOption = select.options[select.selectedIndex]?.text;
            if (selectedOption) {
                alert(`Customization applied for ${itemName}: ${selectedOption}`);
                // Here you could send the customization to the server or update the UI further
            } else {
                alert('Please select a protein option.');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            fetchRestaurants();
            populateFilters();
        });

        // Filter restaurants based on diet
        document.getElementById('diet-filter').addEventListener('change', async (e) => {
            const diet = e.target.value;
            if (!diet) {
                fetchRestaurants();
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/protein-custom-menu-items');
                const items = await response.json();
                const filteredRestaurants = items
                    .filter(item => item.protein_options.some(opt => opt.is_vegan && diet === 'vegan'))
                    .reduce((acc, item) => {
                        if (!acc[item.restaurant_id]) {
                            acc[item.restaurant_id] = {
                                restaurant_id: item.restaurant_id,
                                restaurant_name: item.restaurant_name,
                                menus: []
                            };
                        }
                        let menu = acc[item.restaurant_id].menus.find(m => m.menu_id === item.menu_id);
                        if (!menu) {
                            menu = { menu_id: item.menu_id, menu_name: 'Filtered Menu', items: [] };
                            acc[item.restaurant_id].menus.push(menu);
                        }
                        menu.items.push({
                            menu_item_id: item.menu_item_id,
                            item_name: item.display_name,
                            description: item.description,
                            base_price: item.base_price
                        });
                        return acc;
                    }, {});
                displayRestaurants(Object.values(filteredRestaurants));
            } catch (err) {
                console.error('Error filtering restaurants:', err);
            }
        });
    </script>
</body>
</html>